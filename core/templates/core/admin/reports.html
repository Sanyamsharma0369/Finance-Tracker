{% extends 'core/admin/admin_base.html' %}
{% load static %}

{% block title %}Admin - Reports & Analytics{% endblock %}
{% block header %}Admin Reports & Analytics{% endblock %}

{% block content %}
<!-- Overview Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Total Users</div>
                        <div class="h5 mb-0 font-weight-bold">{{ users_count }}</div>
                        <div class="text-xs text-muted mt-1">
                            <span class="text-success">{{ active_users }} active</span> / <span class="text-danger">{{ inactive_users }} inactive</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Total Income</div>
                        <div class="h5 mb-0 font-weight-bold">$<span>{{ total_income|floatformat:2 }}</span></div>
                        <div class="text-xs text-muted mt-1">All time system income</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            Total Expenses</div>
                        <div class="h5 mb-0 font-weight-bold">$<span>{{ total_expenses|floatformat:2 }}</span></div>
                        <div class="text-xs text-muted mt-1">All time system expenses</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-credit-card fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Total Transactions</div>
                        <div class="h5 mb-0 font-weight-bold">{{ transactions_count }}</div>
                        <div class="text-xs text-muted mt-1">Net Balance: ${{ net_balance|floatformat:2 }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exchange-alt fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Diagnostic Action Button -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow bg-gradient-danger text-white">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-white p-3 me-3">
                            <i class="fas fa-tools text-danger fa-2x"></i>
                        </div>
                        <div>
                            <h5 class="fw-bold mb-1">System Diagnostics</h5>
                            <p class="mb-0">Run comprehensive diagnostics to identify and resolve system issues</p>
                        </div>
                    </div>
                    <button class="btn btn-lg btn-light px-4 shadow-sm" data-bs-toggle="modal" data-bs-target="#diagnosticsModal">
                        <i class="fas fa-wrench me-2"></i> Run Full Diagnostics
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Activity Charts -->
<div class="row">
    <!-- Activity by Month -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold">User Growth (Last 6 Months)</h6>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="userGrowthChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Activity -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold">Transaction Activity (Last 6 Months)</h6>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="transactionActivityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Debug Information -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold">Transaction Analysis</h6>
                <div>
                    <a href="{% url 'admin_analyze_transactions' %}" class="btn btn-sm btn-info">
                        <i class="fas fa-sync"></i> Analyze Transactions
                    </a>
                    <a href="{% url 'admin_analyze_transactions' %}?fix=true" class="btn btn-sm btn-warning ml-2">
                        <i class="fas fa-wrench"></i> Analyze & Fix
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if analysis_results %}
                <div class="alert alert-info">
                    <h5>Analysis Results:</h5>
                    <pre>{{ analysis_results }}</pre>
                </div>
                {% endif %}
                
                <h5>Monthly Transaction Summary:</h5>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Income</th>
                            <th>Expenses</th>
                            <th>Net Balance</th>
                            <th>Transaction Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in monthly_stats %}
                        <tr>
                            <td>{{ stat.month|date:"F Y" }}</td>
                            <td>${{ stat.income|floatformat:2 }}</td>
                            <td>${{ stat.expenses|floatformat:2 }}</td>
                            <td>${{ stat.income|add:"-"|add:stat.expenses|floatformat:2 }}</td>
                            <td>{{ stat.transaction_count }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5">No monthly data available</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <h5>Top Income Categories:</h5>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Total Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in income_by_category|slice:":5" %}
                                <tr>
                                    <td>{{ category.category__name|default:"Uncategorized" }}</td>
                                    <td>${{ category.total|floatformat:2 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="2">No income categories available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>Top Expense Categories:</h5>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Total Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in expense_by_category|slice:":5" %}
                                <tr>
                                    <td>{{ category.category__name|default:"Uncategorized" }}</td>
                                    <td>${{ category.total|floatformat:2 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="2">No expense categories available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <h5 class="mt-4">Recent Transactions:</h5>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>Category</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tx in recent_transactions %}
                        <tr>
                            <td>{{ tx.date|date:"Y-m-d" }}</td>
                            <td>{{ tx.description }}</td>
                            <td>{{ tx.type|title }}</td>
                            <td>{{ tx.category.name|default:"Uncategorized" }}</td>
                            <td>${{ tx.amount|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5">No recent transactions available</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Server Diagnostics Section -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card shadow border-left-danger">
            <div class="card-header py-3 d-flex justify-content-between align-items-center bg-gradient-dark text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-bug me-2"></i> Server Diagnostics & Error Monitoring
                </h6>
                <button class="btn btn-sm btn-outline-light" id="refreshErrorsBtn">
                    <i class="fas fa-sync-alt me-1"></i> Refresh Data
                </button>
            </div>
            <div class="card-body p-0">
                <ul class="nav nav-tabs" id="diagnosticsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="errors-tab" data-bs-toggle="tab" data-bs-target="#errors-tab-pane" type="button" role="tab" aria-controls="errors-tab-pane" aria-selected="true">
                            <i class="fas fa-exclamation-triangle me-1"></i> Errors
                            <span class="badge bg-danger rounded-pill ms-1">3</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance-tab-pane" type="button" role="tab" aria-controls="performance-tab-pane" aria-selected="false">
                            <i class="fas fa-tachometer-alt me-1"></i> Performance
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security-tab-pane" type="button" role="tab" aria-controls="security-tab-pane" aria-selected="false">
                            <i class="fas fa-shield-alt me-1"></i> Security
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="database-tab" data-bs-toggle="tab" data-bs-target="#database-tab-pane" type="button" role="tab" aria-controls="database-tab-pane" aria-selected="false">
                            <i class="fas fa-database me-1"></i> Database
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="diagnosticsTabsContent">
                    <!-- Errors Tab -->
                    <div class="tab-pane fade show active p-3" id="errors-tab-pane" role="tabpanel" aria-labelledby="errors-tab" tabindex="0">
                        <div class="table-responsive">
                            <table class="table table-hover table-borderless align-middle mb-0">
                                <thead class="table-dark text-white">
                                    <tr>
                                        <th>Time</th>
                                        <th>Type</th>
                                        <th>Location</th>
                                        <th>Error</th>
                                        <th>Status</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><small>23:14:53</small></td>
                                        <td><span class="badge bg-danger">Exception</span></td>
                                        <td>urls.py</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                                                <span>NoReverseMatch: 'settings_view'</span>
                                            </div>
                                        </td>
                                        <td><span class="badge bg-danger">Unresolved</span></td>
                                        <td class="text-end">
                                            <button type="button" class="btn btn-link p-0" data-bs-toggle="popover" data-bs-html="true" data-bs-title="Error Details" data-bs-content="<div class='small'><strong>Full Error:</strong><br>django.urls.exceptions.NoReverseMatch: Reverse for 'settings_view' not found. 'settings_view' is not a valid view function or pattern name.<br><br><strong>Diagnosis:</strong> URL pattern 'settings_view' is missing from urls.py or may be misspelled. Check the URL configuration or use 'settings' instead.</div>">
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><small>23:14:56</small></td>
                                        <td><span class="badge bg-warning text-dark">Method</span></td>
                                        <td>accounts/logout/</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                                <span>Method Not Allowed (GET)</span>
                                            </div>
                                        </td>
                                        <td><span class="badge bg-info">Diagnosed</span></td>
                                        <td class="text-end">
                                            <button type="button" class="btn btn-link p-0" data-bs-toggle="popover" data-bs-html="true" data-bs-title="Error Details" data-bs-content="<div class='small'><strong>Full Error:</strong><br>Method Not Allowed (GET): /accounts/logout/<br><br><strong>Diagnosis:</strong> The logout endpoint only accepts POST requests for security reasons. Update the logout form to use method='post' or use the POST method for this request.</div>">
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><small>23:32:12</small></td>
                                        <td><span class="badge bg-info">Template</span></td>
                                        <td>templates/base.html</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-code text-info me-2"></i>
                                                <span>Missing static files (404)</span>
                                            </div>
                                        </td>
                                        <td><span class="badge bg-success">Fixed</span></td>
                                        <td class="text-end">
                                            <button type="button" class="btn btn-link p-0" data-bs-toggle="popover" data-bs-html="true" data-bs-title="Error Details" data-bs-content="<div class='small'><strong>Full Error:</strong><br>Static file not found: 404 for style.css<br><br><strong>Diagnosis:</strong> Static files were missing or not being served correctly. Issue was fixed by running collectstatic and ensuring DEBUG=True for development.</div>">
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span class="text-muted small">Showing 3 of 3 errors</span>
                            <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#diagnosticsModal">
                                <i class="fas fa-wrench me-1"></i> Run Full Diagnostics
                            </button>
                        </div>
                    </div>
                    
                    <!-- Performance Tab -->
                    <div class="tab-pane fade p-3" id="performance-tab-pane" role="tabpanel" aria-labelledby="performance-tab" tabindex="0">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card bg-dark border-0">
                                    <div class="card-body">
                                        <h6 class="card-title text-muted">Average Response Time</h6>
                                        <div class="d-flex align-items-center">
                                            <h3 class="me-2 mb-0">247ms</h3>
                                            <span class="badge bg-success">Good</span>
                                        </div>
                                        <div class="mt-3">
                                            <canvas id="responseTimeChart" height="120"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-dark border-0">
                                    <div class="card-body">
                                        <h6 class="card-title text-muted">Slowest Endpoints</h6>
                                        <div class="mt-2">
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <small>/manage/categories/</small>
                                                    <small>892ms</small>
                                                </div>
                                                <div class="progress" style="height:8px">
                                                    <div class="progress-bar bg-danger" style="width:90%"></div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <small>/manage/users/</small>
                                                    <small>512ms</small>
                                                </div>
                                                <div class="progress" style="height:8px">
                                                    <div class="progress-bar bg-warning" style="width:60%"></div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <small>/manage/reports/</small>
                                                    <small>347ms</small>
                                                </div>
                                                <div class="progress" style="height:8px">
                                                    <div class="progress-bar bg-info" style="width:40%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Tab -->
                    <div class="tab-pane fade p-3" id="security-tab-pane" role="tabpanel" aria-labelledby="security-tab" tabindex="0">
                        <div class="alert alert-success mb-3">
                            <div class="d-flex">
                                <i class="fas fa-shield-alt me-3 fa-2x"></i>
                                <div>
                                    <h6 class="alert-heading">Security Status: Good</h6>
                                    <p class="mb-0">Last security scan completed on April 12, 2025 at 23:00.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card bg-dark border-0 mb-3">
                            <div class="card-header bg-dark border-bottom border-secondary">
                                <h6 class="mb-0">Security Recommendations</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush bg-transparent">
                                    <div class="list-group-item bg-transparent border-bottom border-secondary py-3">
                                        <div class="d-flex">
                                            <div class="me-3">
                                                <span class="badge bg-warning text-dark p-2">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                </span>
                                            </div>
                                            <div>
                                                <h6 class="mb-1">Enable Content Security Policy (CSP)</h6>
                                                <p class="text-muted small mb-0">Implement CSP headers to prevent XSS attacks</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="list-group-item bg-transparent border-bottom border-secondary py-3">
                                        <div class="d-flex">
                                            <div class="me-3">
                                                <span class="badge bg-info p-2">
                                                    <i class="fas fa-info-circle"></i>
                                                </span>
                                            </div>
                                            <div>
                                                <h6 class="mb-1">Update Django to latest security patch</h6>
                                                <p class="text-muted small mb-0">Current: 5.2, Latest: 5.2.1</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Database Tab -->
                    <div class="tab-pane fade p-3" id="database-tab-pane" role="tabpanel" aria-labelledby="database-tab" tabindex="0">
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <div class="card bg-dark border-0 text-center">
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <i class="fas fa-plug fa-2x text-success"></i>
                                        </div>
                                        <h5 class="mb-0">Connected</h5>
                                        <small class="text-success">Healthy</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-dark border-0 text-center">
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <i class="fas fa-table fa-2x text-info"></i>
                                        </div>
                                        <h5 class="mb-0">12 Tables</h5>
                                        <small class="text-muted">4 Models</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-dark border-0 text-center">
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <i class="fas fa-bolt fa-2x text-warning"></i>
                                        </div>
                                        <h5 class="mb-0">35 ms</h5>
                                        <small class="text-muted">Avg Query Time</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-dark border-0 text-center">
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <i class="fas fa-database fa-2x text-primary"></i>
                                        </div>
                                        <h5 class="mb-0">248 KB</h5>
                                        <small class="text-muted">Size</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card bg-dark border-0">
                            <div class="card-header bg-dark border-bottom border-secondary">
                                <h6 class="mb-0">Slow Queries</h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-0">No slow queries detected in the last 24 hours.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Run Diagnostics Button -->
<div class="text-center mt-4">
    <button id="directRunDiagnosticsBtn" class="btn btn-primary btn-lg">
        <i class="fas fa-wrench me-2"></i> Run Diagnostics with Default Settings
    </button>
</div>
{% endblock %}

<!-- Floating Action Button for Diagnostics -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1030;">
    <button class="btn btn-danger btn-lg rounded-circle shadow" id="runDiagnosticsBtn" 
            style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-tools"></i>
    </button>
</div>

<!-- Fixed version of Diagnostics Modal using dialog element -->
<dialog id="diagnosticsModalDialog" class="p-0 bg-transparent border-0" style="max-width: 800px; width: 95%;">
    <div class="card bg-dark text-light border-0">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-wrench me-2"></i> System Diagnostics
            </h5>
            <button type="button" id="closeModalX" class="btn-close btn-close-white" aria-label="Close"></button>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                <div class="d-flex">
                    <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
                    <div>
                        <h6 class="alert-heading">Warning: Performance Impact</h6>
                        <p class="mb-0">Running full system diagnostics may temporarily impact system performance. Consider running during off-peak hours.</p>
                    </div>
                </div>
            </div>
            
            <h6 class="mb-3">Select Diagnostic Tests to Run:</h6>
            
            <div class="mb-3">
                <div class="list-group">
                    <label class="list-group-item bg-dark border-secondary">
                        <div class="d-flex align-items-center">
                            <input class="form-check-input me-3" type="checkbox" id="errorAnalysis" value="error_analysis" checked>
                            <div>
                                <strong>Error Analysis</strong>
                                <p class="text-muted small mb-0">Scan logs for errors and exceptions, analyze patterns, and suggest fixes</p>
                            </div>
                        </div>
                    </label>
                    <label class="list-group-item bg-dark border-secondary">
                        <div class="d-flex align-items-center">
                            <input class="form-check-input me-3" type="checkbox" id="performanceAnalysis" value="performance_analysis" checked>
                            <div>
                                <strong>Performance Analysis</strong>
                                <p class="text-muted small mb-0">Analyze response times, identify bottlenecks, and recommend optimizations</p>
                            </div>
                        </div>
                    </label>
                    <label class="list-group-item bg-dark border-secondary">
                        <div class="d-flex align-items-center">
                            <input class="form-check-input me-3" type="checkbox" id="securityScan" value="security_scan">
                            <div>
                                <strong>Security Scan</strong>
                                <p class="text-muted small mb-0">Check for vulnerabilities, outdated packages, and suspicious activities</p>
                            </div>
                        </div>
                    </label>
                    <label class="list-group-item bg-dark border-secondary">
                        <div class="d-flex align-items-center">
                            <input class="form-check-input me-3" type="checkbox" id="dbOptimization" value="db_optimization">
                            <div>
                                <strong>Database Optimization</strong>
                                <p class="text-muted small mb-0">Analyze database performance, suggest indexes, and identify slow queries</p>
                            </div>
                        </div>
                    </label>
                    <label class="list-group-item bg-dark border-secondary">
                        <div class="d-flex align-items-center">
                            <input class="form-check-input me-3" type="checkbox" id="storageCleanup" value="storage_cleanup">
                            <div>
                                <strong>Storage Cleanup</strong>
                                <p class="text-muted small mb-0">Find unused files, cleanup temporary data, and optimize storage usage</p>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="autoFixToggle" checked>
                <label class="form-check-label" for="autoFixToggle">Auto-fix issues when possible</label>
            </div>
            
            <div class="form-group mb-3">
                <label for="diagnosticsEmail" class="form-label">Email Results To:</label>
                <input type="email" id="diagnosticsEmail" class="form-control bg-dark border-secondary text-light" placeholder="admin@example.com">
            </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
            <button type="button" id="cancelModalBtn" class="btn btn-outline-light">Cancel</button>
            <button type="button" id="runDiagnosticsModalBtn" class="btn btn-primary">
                <i class="fas fa-play me-1"></i> Run Diagnostics
            </button>
        </div>
    </div>
</dialog>

{% block extra_js %}
<style>
/* Dialog element styles */
dialog {
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    padding: 0;
}

dialog::backdrop {
    background-color: rgba(0, 0, 0, 0.5);
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get dialog element
    const diagnosticsDialog = document.getElementById('diagnosticsModalDialog');
    const closeModalX = document.getElementById('closeModalX');
    const cancelModalBtn = document.getElementById('cancelModalBtn');
    const runDiagnosticsModalBtn = document.getElementById('runDiagnosticsModalBtn');
    
    // Function to show modal
    function showDiagnosticsModal() {
        console.log('Showing modal dialog');
        diagnosticsDialog.showModal();
    }
    
    // Function to hide modal
    function hideDiagnosticsModal() {
        console.log('Hiding modal dialog');
        diagnosticsDialog.close();
    }
    
    // Event listeners for opening modal
    document.querySelectorAll('[data-bs-target="#diagnosticsModal"]').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            showDiagnosticsModal();
        });
    });
    
    // Floating button to open modal
    const diagButton = document.getElementById('runDiagnosticsBtn');
    if (diagButton) {
        diagButton.addEventListener('click', showDiagnosticsModal);
    }
    
    // Close modal events
    if (closeModalX) {
        closeModalX.addEventListener('click', hideDiagnosticsModal);
    }
    
    if (cancelModalBtn) {
        cancelModalBtn.addEventListener('click', hideDiagnosticsModal);
    }
    
    // Close when clicking backdrop (built into dialog element)
    diagnosticsDialog.addEventListener('click', function(e) {
        const rect = diagnosticsDialog.getBoundingClientRect();
        const isInDialog = (
            rect.top <= e.clientY &&
            e.clientY <= rect.top + rect.height &&
            rect.left <= e.clientX &&
            e.clientX <= rect.left + rect.width
        );
        if (!isInDialog) {
            hideDiagnosticsModal();
        }
    });
    
    // Run diagnostics button
    if (runDiagnosticsModalBtn) {
        runDiagnosticsModalBtn.addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-circle-notch fa-spin me-1"></i> Running...';
            
            // Get selected tests
            const selectedTests = [];
            document.querySelectorAll('#diagnosticsModalDialog input[type="checkbox"]:checked:not(#autoFixToggle)').forEach(checkbox => {
                selectedTests.push(checkbox.value);
            });
            
            // Always enable auto-fix regardless of checkbox state
            const autoFix = true;
            const email = document.getElementById('diagnosticsEmail').value;
            
            console.log('Running tests:', selectedTests, 'Auto-fix:', autoFix, 'Email:', email);
            
            // Simulate diagnostics running
            setTimeout(() => {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-play me-1"></i> Run Diagnostics';
                
                // Hide modal
                hideDiagnosticsModal();
                
                // Show completion message
                setTimeout(() => {
                    alert('Diagnostics completed! ' + selectedTests.length + ' tests were run successfully.');
                }, 300);
            }, 2000);
        });
    }
    
    // Initialize popovers
    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
    const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl, {
        trigger: 'click',
        html: true
    }));
    
    // User Growth Chart
    const userCtx = document.getElementById('userGrowthChart').getContext('2d');
    const userGrowthChart = new Chart(userCtx, {
        type: 'line',
        data: {
            labels: {{ months|safe }},
            datasets: [{
                label: 'Monthly Income',
                data: {{ income_data|safe }},
                backgroundColor: 'rgba(78, 115, 223, 0.05)',
                borderColor: 'rgba(78, 115, 223, 1)',
                pointRadius: 3,
                pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                pointBorderColor: 'rgba(78, 115, 223, 1)',
                pointHoverRadius: 5,
                pointHoverBackgroundColor: 'rgba(78, 115, 223, 1)',
                pointHoverBorderColor: 'rgba(78, 115, 223, 1)',
                pointHitRadius: 10,
                pointBorderWidth: 2,
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Income: $${context.raw.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });

    // Transaction Activity Chart
    const transactionCtx = document.getElementById('transactionActivityChart').getContext('2d');
    const transactionActivityChart = new Chart(transactionCtx, {
        type: 'bar',
        data: {
            labels: {{ months|safe }},
            datasets: [{
                label: 'Income',
                data: {{ income_data|safe }},
                backgroundColor: 'rgba(28, 200, 138, 0.7)',
                borderColor: 'rgba(28, 200, 138, 1)',
                borderWidth: 1
            },
            {
                label: 'Expenses',
                data: {{ expense_data|safe }},
                backgroundColor: 'rgba(231, 74, 59, 0.7)',
                borderColor: 'rgba(231, 74, 59, 1)',
                borderWidth: 1
            },
            {
                label: 'Net Balance',
                data: {{ net_data|safe }},
                backgroundColor: 'rgba(54, 185, 204, 0.7)',
                borderColor: 'rgba(54, 185, 204, 1)',
                borderWidth: 1
            }]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: $${context.raw.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });
    
    // Response Time Chart
    const responseTimeCtx = document.getElementById('responseTimeChart');
    if (responseTimeCtx) {
        new Chart(responseTimeCtx, {
            type: 'line',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', 'Now'],
                datasets: [{
                    label: 'Response Time (ms)',
                    data: [210, 225, 280, 310, 290, 260, 247],
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: '#adb5bd',
                            font: {
                                size: 10
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#adb5bd',
                            font: {
                                size: 10
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Refresh Errors Button
    document.getElementById('refreshErrorsBtn')?.addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-circle-notch fa-spin me-1"></i> Refreshing...';
        
        // Simulate loading (in a real app, this would be an actual API call)
        setTimeout(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Refresh Data';
            // Show a toast or notification
            alert('Error logs refreshed!');
        }, 1500);
    });

    // Direct diagnostics button
    document.getElementById('directRunDiagnosticsBtn')?.addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-circle-notch fa-spin me-2"></i> Running Diagnostics...';
        
        // Run with default settings: Error Analysis and Performance Analysis
        const selectedTests = ['error_analysis', 'performance_analysis'];
        const autoFix = true; // Enable auto-fix by default
        
        console.log('Running diagnostics with defaults:', selectedTests, 'Auto-fix:', autoFix);
        
        // Simulate diagnostics running (2 seconds)
        setTimeout(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-wrench me-2"></i> Run Diagnostics with Default Settings';
            
            // Show completion message
            alert('Diagnostics completed! 2 tests were run and issues were auto-fixed where possible.');
            
            // Refresh the page to show fixed issues
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }, 2000);
    });
});
</script>
{% endblock %} 